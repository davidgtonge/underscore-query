define(function(){var e,r,t,n,u,a,s,i,o,c,l,f,y,h,p,$,d,g,m,k,v,b,w,O,x,q,j=[].slice,E=[].indexOf||function(e){for(var r=0,t=this.length;t>r;r++)if(r in this&&this[r]===e)return r;return-1},A={}.hasOwnProperty;for($=this,w={},b=function(){var e;return e={},["every","some","filter","reduce","map"].forEach(function(r){return e[r]=function(){var e,t;return t=arguments[0],e=2<=arguments.length?j.call(arguments,1):[],t[r].apply(t,e)}}),e.keys=Object.keys,e.isArray=Array.isArray,e.result=function(e,r){return null==e&&(e={}),"Function"===w.getType(e[r])?e[r]():e[r]},e.detect=function(e,r){var t,n,u;for(n=0,u=e.length;u>n;n++)if(t=e[n],r(t))return t},e.reject=function(e,r){var t,n,u,a;for(a=[],n=0,u=e.length;u>n;n++)t=e[n],r(t)||a.push(t);return a},e.intersection=function(e,r){var t,n,u,a;for(a=[],n=0,u=e.length;u>n;n++)t=e[n],-1!==r.indexOf(t)&&a.push(t);return a},e.isEqual=function(e,r){return JSON.stringify(e)===JSON.stringify(r)},e},n=function(e){var r,t,n,u;for(u=["every","some","filter","detect","reject","reduce","intersection","isEqual","keys","isArray","result","map"],t=0,n=u.length;n>t;t++)if(r=u[t],w[r]=e[r],!w[r])throw new Error(""+r+" missing. Please ensure that you first initialize underscore-query with either lodash or underscore")},w.getType=function(e){var r;return r=Object.prototype.toString.call(e).substr(8),r.substr(0,r.length-1)},w.makeObj=function(e,r){var t;return(t={})[e]=r,t},w.reverseString=function(e){return e.toLowerCase().split("").reverse().join("")},w.compoundKeys=["$and","$not","$or","$nor"],w.makeGetter=function(e){return e=e.split("."),function(r){var t,n,u,a;for(n=r,u=0,a=e.length;a>u;u++)t=e[u],n&&(n=w.result(n,t));return n}},o=function(e,r){var t,n,u;u=[];for(t in r)n=r[t],u.push(w.makeObj(e,w.makeObj(t,n)));return u},l=function(e){var r,t,n,u,a,s;switch(r=w.keys(e)[0],u=e[r],t={key:r},(null!=u?u.$boost:void 0)&&(t.boost=u.$boost,delete u.$boost),-1!==r.indexOf(".")&&(t.getter=w.makeGetter(r)),n=w.getType(u)){case"RegExp":case"Date":t.type="$"+n.toLowerCase(),t.value=u;break;case"Object":if(E.call(w.compoundKeys,r)>=0)t.type=r,t.value=y(u),t.key=null;else if(w.keys(u).length>1)t.type="$and",t.value=y(o(r,u)),t.key=null;else for(a in u)if(A.call(u,a)){if(s=u[a],!v(a,s))throw new Error("Query value ("+s+") doesn't match query type: ("+a+")");switch(t.type=a,a){case"$elemMatch":t.value=m(f(s));break;case"$endsWith":t.value=w.reverseString(s);break;case"$likeI":case"$startsWith":t.value=s.toLowerCase();break;case"$not":case"$nor":case"$or":case"$and":t.value=y(w.makeObj(t.key,s)),t.key=null;break;case"$computed":t=l(w.makeObj(r,s)),t.getter=w.makeGetter(r);break;default:t.value=s}}break;default:t.type="$equal",t.value=u}return"$equal"!==t.type||"Object"!==n&&"Array"!==n||(t.type="$deepEqual"),t},y=function(e){var r,t,n,u,a,s,i;for(n=w.isArray(e)?e:function(){var t;t=[];for(r in e)A.call(e,r)&&(u=e[r],t.push(w.makeObj(r,u)));return t}(),i=[],a=0,s=n.length;s>a;a++)t=n[a],i.push(l(t));return i},v=function(e,r){var t;switch(t=w.getType(r),e){case"$in":case"$nin":case"$all":case"$any":return"Array"===t;case"$size":return"Number"===t;case"$regex":case"$regexp":return"RegExp"===t;case"$like":case"$likeI":return"String"===t;case"$between":case"$mod":return"Array"===t&&2===r.length;case"$cb":return"Function"===t;default:return!0}},k=function(e,r){var t;switch(t=w.getType(r),e){case"$like":case"$likeI":case"$regex":case"$startsWith":case"$endsWith":return"String"===t;case"$contains":case"$all":case"$any":case"$elemMatch":return"Array"===t;case"$size":return"String"===t||"Array"===t;case"$in":case"$nin":return null!=r;default:return!0}},h=function(e,r,t,n,u){switch(e){case"$equal":return w.isArray(t)?E.call(t,r)>=0:t===r;case"$deepEqual":return w.isEqual(t,r);case"$contains":return E.call(t,r)>=0;case"$ne":return t!==r;case"$lt":return r>t;case"$gt":return t>r;case"$lte":return r>=t;case"$gte":return t>=r;case"$between":return r[0]<t&&t<r[1];case"$betweene":return r[0]<=t&&t<=r[1];case"$in":return E.call(r,t)>=0;case"$nin":return E.call(r,t)<0;case"$all":return w.every(r,function(e){return E.call(t,e)>=0});case"$any":return w.some(t,function(e){return E.call(r,e)>=0});case"$size":return t.length===r;case"$exists":case"$has":return null!=t===r;case"$like":return-1!==t.indexOf(r);case"$likeI":return-1!==t.toLowerCase().indexOf(r);case"$startsWith":return 0===t.toLowerCase().indexOf(r);case"$endsWith":return 0===w.reverseString(t).indexOf(r);case"$type":return typeof t===r;case"$regex":case"$regexp":return r.test(t);case"$cb":return r.call(n,t);case"$mod":return t%r[0]===r[1];case"$elemMatch":return d(t,r,null,!0);case"$and":case"$or":case"$nor":case"$not":return p(e,r,u,n);default:return!1}},m=function(e,r,t){var n,u;if("String"===w.getType(r)&&(n=r,r=function(e,r){return e[n](r)}),t){if(1!==e.length)throw new Error("score operations currently don't work on compound queries");if(u=e[0],"$and"!==u.type)throw new Error("score operations only work on $and queries (not "+u.type);return function(e){return e._score=p(u.type,u.parsedQuery,r,e,!0),e}}return function(n){var a,s;for(a=0,s=e.length;s>a;a++)if(u=e[a],!p(u.type,u.parsedQuery,r,n,t))return!1;return!0}},p=function(e,r,t,n,u){var a,s,i,o,c,l,f,y,p,$;for(i=0,c=0,l=1/r.length,y=0,p=r.length;p>y;y++)switch(o=r[y],a=o.getter?o.getter(n,o.key):t?t(n,o.key):n[o.key],f=k(o.type,a),f&&(f=h(o.type,o.value,a,n,t)),f&&(i++,u&&(s=null!=($=o.boost)?$:1,c+=l*s)),e){case"$and":if(!u&&!f)return!1;break;case"$not":if(f)return!1;break;case"$or":if(f)return!0;break;case"$nor":if(f)return!1;break;default:throw new Error("Invalid compound method")}return u?c:"$not"===e?0===i:"$or"!==e},f=function(e){var r,t,n,u,a;if(n=w.keys(e),!n.length)return[];if(r=w.intersection(w.compoundKeys,n),0===r.length)return[{type:"$and",parsedQuery:y(e)}];if(r.length!==n.length){E.call(r,"$and")<0&&(e.$and={},r.unshift("$and"));for(t in e)A.call(e,t)&&(a=e[t],E.call(w.compoundKeys,t)<0&&(e.$and[t]=a,delete e[t]))}return function(){var t,n,a;for(a=[],t=0,n=r.length;n>t;t++)u=r[t],a.push({type:u,parsedQuery:y(e[u])});return a}()},c=function(e){var r;return"String"===w.getType(e)&&(r=e,e=function(e,t){return e[r](t)}),e},e=function(){function e(e,r){this.items=e,this._getter=r,this.theQuery={}}return e.prototype.all=function(e,r){return e&&(this.items=e),e=this.indexes?this.getIndexedItems(this.items):this.items,d(e,this.theQuery,this._getter,r)},e.prototype.chain=function(){return _.chain(this.all.apply(this,arguments))},e.prototype.tester=function(){return i(this.theQuery,this._getter)},e.prototype.first=function(e){return this.all(e,!0)},e.prototype.getter=function(e){return this._getter=e,this},e}(),r=function(e){return function(r,t){var n;return t&&(r=w.makeObj(r,t)),null==(n=this.theQuery)[e]&&(n[e]=[]),this.theQuery[e].push(r),this}},q=w.compoundKeys,O=0,x=q.length;x>O;O++)s=q[O],e.prototype[s.substr(1)]=r(s);return e.prototype.find=e.prototype.query=e.prototype.run=e.prototype.all,t=function(r,t){return new e(r,t)},i=function(e,r){return m(f(e),c(r))},a=function(e,r,t){return d(e,r,t,!0)},d=function(e,r,n,u,a){var s;return arguments.length<2?t.apply(this,arguments):(n&&(n=c(n)),"Function"!==w.getType(r)&&(r=m(f(r),n,a)),(s=a?w.map:u?w.detect:w.filter)(e,r))},g=function(e,r,t){return d(e,r,t,!1,!0)},d.build=t,d.parse=f,d.findOne=d.first=a,d.score=g,d.tester=d.testWith=i,d.getter=d.pluckWith=w.makeGetter,u=function(e,r){return null==r&&(r=!0),e||(e=b(),r=!1),n(e),r&&e.mixin({query:d,q:d}),d},$._?u($._):exports&&("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=u:u});